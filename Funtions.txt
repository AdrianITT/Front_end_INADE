
def llenar_procesar_croquis(request, aguaresidualinforme_id):
    from openpyxl import load_workbook
    from django.shortcuts import get_object_or_404
    import os
    from openpyxl.drawing.image import Image

    ruta_plantilla = "media/aguasCampo/AguasResiduales2.xlsx"
    wb = load_workbook(ruta_plantilla)

    # Obtiene las plantillas
    hoja_calibracion_c = wb ["CalibracionVerificacionC"]
    hoja_calibracion_ph = wb ["CalibracionVerificacionPh"]
    hoja_protocolo_plantilla = wb["ProtocoloMuestreo"]
    hoja_campo_plantilla = wb["HojaCampo"]

    # Listas para hojas
    hojas_protocolo = []
    hojas_campo = []

    informe = get_object_or_404(AguaResidualInforme, id=aguaresidualinforme_id)
    croquis = informe.CroquisUbicacion
    orden = informe.OrdenTrabajo
    cotizacion = orden.cotizacion
    cliente = cotizacion.cliente
    empresa = cliente.empresa
    organizacion= empresa.organizacion
    logo_path = os.path.join(settings.MEDIA_ROOT, str(organizacion.logo))
    img = Image(logo_path)

    # (Opcional) Cambiar tama√±o
    img.width = 80
    img.height = 50
    
    receptor = orden.receptor

    #----------AQUI PONER LA PARTE DEL CROQUIS EN LA HOJA DE CROQUIS----------#
    from django.http import FileResponse
    
    procesar_croquis(wb=wb, croquis=croquis, logo_path=logo_path)
    
    # Guardar y retornar el archivo
    ruta_salida = f"media/aguasCampo/temp/InformeAguas_{informe.id}.xlsx"
    os.makedirs(os.path.dirname(ruta_salida), exist_ok=True)
    wb.save(ruta_salida)
    return FileResponse(open(ruta_salida, 'rb'), as_attachment=True, filename=os.path.basename(ruta_salida))
